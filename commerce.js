!function(t){"use strict";var e,r,o,n=e={track:function(t,e){var r;if(null!=("undefined"!=typeof window&&null!==window?window.analytics:void 0))try{return window.analytics.track(t,e)}catch(t){return r=t,console.error(r)}}},i=r=function(){function t(t){this.state=t.state,this.value=t.value,this.reason=t.reason}return t.prototype.isFulfilled=function(){return"fulfilled"===this.state},t.prototype.isRejected=function(){return"rejected"===this.state},t}();o=function(){var t,e,r,o,n;return o=[],n=0,t=1024,e=function(){for(var e;o.length-n;){try{o[n]()}catch(t){e=t,"undefined"!=typeof console&&console.error(e)}o[n++]=void 0,n===t&&(o.splice(0,t),n=0)}},r=function(){var t,r;return"undefined"!=typeof MutationObserver?(t=document.createElement("div"),r=new MutationObserver(e),r.observe(t,{attributes:!0}),function(){t.setAttribute("a",0)}):"undefined"!=typeof setImmediate?function(){setImmediate(e)}:function(){setTimeout(e,0)}}(),function(t){o.push(t),o.length-n==1&&r()}}();var a,s,u,c,d,l,p,h=o;d=void 0,u=d,s="fulfilled",c="rejected",p=function(t,e){var r,o;if("function"==typeof t.y)try{o=t.y.call(d,e),t.p.resolve(o)}catch(e){r=e,t.p.reject(r)}else t.p.resolve(e)},l=function(t,e){var r,o;if("function"==typeof t.n)try{o=t.n.call(d,e),t.p.resolve(o)}catch(e){r=e,t.p.reject(r)}else t.p.reject(e)},a=function(){function t(t){t&&t(function(t){return function(e){return t.resolve(e)}}(this),function(t){return function(e){return t.reject(e)}}(this))}return t.prototype.resolve=function(t){var e,r,o,n;if(this.state===u){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));if(t&&("function"==typeof t||"object"==typeof t))try{if(o=!0,"function"==typeof(n=t.then))return void n.call(t,function(t){return function(e){o&&(o&&(o=!1),t.resolve(e))}}(this),function(t){return function(e){o&&(o=!1,t.reject(e))}}(this))}catch(t){return r=t,void(o&&this.reject(r))}this.state=s,this.v=t,(e=this.c)&&h(function(r){return function(){var r,o,n;for(o=0,n=e.length;o<n;o++)r=e[o],p(r,t)}}())}},t.prototype.reject=function(e){var r;this.state===u&&(this.state=c,this.v=e,(r=this.c)?h(function(){var t,o,n;for(o=0,n=r.length;o<n;o++)t=r[o],l(t,e)}):t.suppressUncaughtRejectionError||"undefined"==typeof console||console.log("Broken Promise, please catch rejections: ",e,e?e.stack:null))},t.prototype.then=function(e,r){var o,n,i,a;return i=new t,n={y:e,n:r,p:i},this.state===u?this.c?this.c.push(n):this.c=[n]:(a=this.state,o=this.v,h(function(){a===s?p(n,o):l(n,o)})),i},t.prototype.catch=function(t){return this.then(null,t)},t.prototype.finally=function(t){return this.then(t,t)},t.prototype.timeout=function(e,r){return r=r||"timeout",new t(function(t){return function(o,n){setTimeout(function(){return n(Error(r))},e),t.then(function(t){o(t)},function(t){n(t)})}}(this))},t.prototype.callback=function(t){return"function"==typeof t&&(this.then(function(e){return t(null,e)}),this.catch(function(e){return t(e,null)})),this},t}();var f=a,g=function(t){var e;return e=new f,e.resolve(t),e},y=function(t){var e;return e=new f,e.reject(t),e},v=function(t){var e,r,o,n,i,a,s,u;for(s=[],i=0,u=new f,a=function(e,r){e&&"function"==typeof e.then||(e=g(e)),e.then(function(e){s[r]=e,++i===t.length&&u.resolve(s)},function(t){u.reject(t)})},e=r=0,o=t.length;r<o;e=++r)n=t[e],a(n,e);return t.length||u.resolve(s),u},m=function(t){return new f(function(e,r){return t.then(function(t){return e(new i({state:"fulfilled",value:t}))}).catch(function(t){return e(new i({state:"rejected",reason:t}))})})},w=function(t){return v(t.map(m))};f.all=v,f.reflect=m,f.reject=y,f.resolve=g,f.settle=w,f.soon=h;var I;I=function(){function t(t,e,r){this.client=t,this.data=e,this.opts=null!=r?r:{},this.queue=[],this.invoice()}return t.prototype.waits=0,t.prototype.queue=null,t.prototype.data=null,t.prototype.client=null,t.prototype.cartPromise=null,t.prototype.promise=null,t.prototype.reject=null,t.prototype.resolve=null,t.prototype.opts={},t.prototype.initCart=function(){var t,e,r,o,n,i;if((t=this.data.get("order.cartId"))||null==this.client.cart){for(this.onCart(t),o=this.data.get("order.items"),e=n=0,i=o.length;n<i;e=++n)r=o[e],this._cartSet(r.productId,r.quantity);return this.onCart(t)}return this.client.cart.create().then(function(t){return function(e){var r,o,n,i,a;for(t.data.set("order.cartId",e.id),n=t.data.get("order.items"),r=i=0,a=n.length;i<a;r=++i)o=n[r],t._cartSet(o.productId,o.quantity);return t.onCart(e.id)}}(this))},t.prototype.onCart=function(t){},t.prototype._cartSet=function(t,e){var r;if((r=this.data.get("order.cartId"))&&null!=this.client.cart)return this.client.cart.set({id:r,productId:t,quantity:e})},t.prototype._cartUpdate=function(t){var e;if((e=this.data.get("order.cartId"))&&null!=this.client.cart)return t.id=e,this.client.cart.update(t)},t.prototype.set=function(t,e,r){return null==r&&(r=!1),this.queue.push([t,e,r]),1===this.queue.length&&(this.promise=new f(function(t){return function(e,r){return t.resolve=e,t.reject=r}}(this)),this._set()),this.promise},t.prototype.get=function(t){var e,r,o,n,i,a,s,u;for(o=this.data.get("order.items"),e=n=0,a=o.length;n<a;e=++n)if(r=o[e],r.id===t||r.productId===t||r.productSlug===t)return r;for(u=this.queue,e=i=0,s=u.length;i<s;e=++i)if(r=u[e],r[0]===t)return{id:r[0],quantity:r[2],locked:r[3]}},t.prototype._set=function(){var t,e,r,o,i,a,s,u,c,d,l,p,h,f,g;if(a=this.data.get("order.items"),0===this.queue.length)return this.invoice(),void(null!=this.resolve&&this.resolve(a));if(g=this.queue[0],o=g[0],f=g[1],l=g[2],0===f){for(r=s=0,c=a.length;s<c&&(i=a[r],i.productId!==o&&i.productSlug!==o&&i.id!==o);r=++s);return r<a.length&&(this.data.set("order.items",[]),a.splice(r,1),this.onUpdate(),t={id:i.productId,sku:i.productSlug,name:i.productName,quantity:i.quantity,price:parseFloat(i.price/100)},null!=this.opts.analyticsProductTransform&&(t=this.opts.analyticsProductTransform(t)),n.track("Removed Product",t),this.data.set("order.items",a),this._cartSet(i.productId,0),this.onUpdate(i)),this.queue.shift(),void this._set()}for(r=u=0,d=a.length;u<d;r=++u)if(i=a[r],i.id===o||i.productId===o||i.productSlug===o)return h=i.quantity,i.quantity=f,i.locked=l,p=f,e=p-h,e>0?(t={id:i.productId,sku:i.productSlug,name:i.productName,quantity:e,price:parseFloat(i.price/100)},null!=this.opts.analyticsProductTransform&&(t=this.opts.analyticsProductTransform(t)),n.track("Added Product",t)):e<0&&(t={id:i.productId,sku:i.productSlug,name:i.productName,quantity:e,price:parseFloat(i.price/100)},null!=this.opts.analyticsProductTransform&&(t=this.opts.analyticsProductTransform(t)),n.track("Removed Product",t)),this.data.set("order.items."+r+".quantity",f),this.data.set("order.items."+r+".locked",l),this._cartSet(i.productId,f),this.onUpdate(i),this.queue.shift(),void this._set();return a.push({id:o,quantity:f,locked:l}),this.waits++,this.load(o)},t.prototype.load=function(t){return this.client.product.get(t).then(function(t){return function(e){var r,o,i,a,s,u;for(t.waits--,a=t.data.get("order.items"),o=s=0,u=a.length;s<u;o=++s)if(i=a[o],e.id===i.id||e.slug===i.id){r={id:e.id,sku:e.slug,name:e.name,quantity:i.quantity,price:parseFloat(e.price/100)},null!=t.opts.analyticsProductTransform&&(r=t.opts.analyticsProductTransform(r)),n.track("Added Product",r),t.update(e,i),t.data.set("order.items."+o,i),t._cartSet(e.id,i.quantity);break}return t.queue.shift(),t._set()}}(this)).catch(function(e){return function(r){var o,n,i,a,s;for(e.waits--,console.log("setItem Error: "+r.stack),i=e.data.get("order.items"),o=a=0,s=i.length;a<s;o=++a)if(n=i[o],n.id===t){i.splice(o,1),e.data.set("order.items",i);break}return e.queue.shift(),e._set()}}(this))},t.prototype.refresh=function(t){var e;return e=this.data.get("order.items"),this.client.product.get(t).then(function(t){return function(r){var o,n,i,a;for(t.waits--,o=i=0,a=e.length;i<a;o=++i)if(n=e[o],r.id===n.productId||r.slug===n.productSlug){t.update(r,n);break}return e}}(this)).catch(function(t){return console.log("setItem Error: "+t)})},t.prototype.update=function(t,e){return delete e.id,e.productId=t.id,e.productSlug=t.slug,e.productName=t.name,e.price=t.price,e.listPrice=t.listPrice,e.description=t.description,this.onUpdate(e)},t.prototype.onUpdate=function(t){},t.prototype.promoCode=function(t){return null!=t?(this.invoice(),this.client.coupon.get(t).then(function(e){return function(r){if(!r.enabled)throw new Error("This code is expired.");if(e.data.set("order.coupon",r),e.data.set("order.couponCodes",[t]),e._cartUpdate({coupon:r,couponCodes:[t]}),""!==r.freeProductId&&r.freeQuantity>0)return e.client.product.get(r.freeProductId).then(function(t){return e.invoice()}).catch(function(t){throw new Error("This coupon is invalid.")});e.invoice()}}(this))):this.data.get("order.promoCode")},t.prototype.taxRates=function(t){return null!=t&&(this.data.set("taxRates",t),this.invoice()),this.data.get("taxRates")},t.prototype.shippingRates=function(t){return null!=t&&(this.data.set("shippingRates",t),this.invoice()),this.data.get("shippingRates")},t.prototype.invoice=function(){var t,e,r,o,n,i,a,s,u,c,d,l,p,h,f,g,y,v,m,w,I,C,q,k,P,R,j,L,b,S,T,x,E,_,A;if(i=this.data.get("order.items"),o=0,null!=(r=this.data.get("order.coupon")))switch(r.type){case"flat":if(null==r.productId||""===r.productId)o=r.amount||0;else for(I=this.data.get("order.items"),a=0,c=I.length;a<c;a++)n=I[a],n.productId===r.productId&&(w=n.quantity,r.once&&(w=1),o+=(r.amount||0)*w);break;case"percent":if(null==r.productId||""===r.productId)for(C=this.data.get("order.items"),s=0,d=C.length;s<d;s++)n=C[s],w=n.quantity,r.once&&(w=1),o+=(r.amount||0)*n.price*w*.01;else for(q=this.data.get("order.items"),u=0,l=q.length;u<l;u++)n=q[u],n.productId===r.productId&&(w=n.quantity,r.once&&(w=1),o+=(r.amount||0)*n.price*w*.01);o=Math.floor(o)}for(this.data.set("order.discount",o),i=this.data.get("order.items"),T=-o,g=0,p=i.length;g<p;g++)n=i[g],T+=n.price*n.quantity;if(this.data.set("order.subtotal",T),null!=(A=this.data.get("taxRates")))for(y=0,h=A.length;y<h;y++)if(_=A[y],(t=this.data.get("order.shippingAddress.city"))&&(null==_.city||_.city.toLowerCase()===t.toLowerCase())&&(m=this.data.get("order.shippingAddress.postalCode"))&&(null==_.postalCode||_.postalCode.toLowerCase()===m.toLowerCase())&&(S=this.data.get("order.shippingAddress.state"))&&(null==_.state||_.state.toLowerCase()===S.toLowerCase())&&(e=this.data.get("order.shippingAddress.country"))&&(null==_.country||_.country.toLowerCase()===e.toLowerCase())){this.data.set("order.taxRate",_.taxRate);break}if(null!=(b=this.data.get("shippingRates")))for(v=0,f=b.length;v<f;v++)if(L=b[v],(t=this.data.get("order.shippingAddress.city"))&&(null==L.city||L.city.toLowerCase()===t.toLowerCase())&&(m=this.data.get("order.shippingAddress.postalCode"))&&(null==L.postalCode||L.postalCode.toLowerCase()===m.toLowerCase())&&(S=this.data.get("order.shippingAddress.state"))&&(null==L.state||L.state.toLowerCase()===S.toLowerCase())&&(e=this.data.get("order.shippingAddress.country"))&&(null==L.country||L.country.toLowerCase()===e.toLowerCase())){this.data.set("order.shippingRate",L.shippingRate);break}return E=null!=(k=this.data.get("order.taxRate"))?k:0,x=Math.ceil((null!=E?E:0)*T),j=null!=(P=this.data.get("order.shippingRate"))?P:0,R=j,this.data.set("order.shipping",R),this.data.set("order.tax",x),this.data.set("order.total",T+R+x)},t.prototype.checkout=function(){var t;return this.invoice(),t={user:this.data.get("user"),order:this.data.get("order"),payment:this.data.get("payment")},this.client.checkout.authorize(t).then(function(e){return function(r){var o,i,a,s,u,c,d,l,p,h;for(e.data.set("coupon",e.data.get("order.coupon")||{}),e.data.set("order",r),d=e.client.checkout.capture(r.id).then(function(t){return e.data.set("order",t),t}).catch(function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.Raven)&&e.captureException(t),console.log("capture Error: "+t)}),h=e.data.get("referralProgram"),null!=h&&(l=e.client.referrer.create({userId:t.order.userId,orderId:t.order.orderId,program:h,programId:e.data.get("referralProgram.id")}).catch(function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.Raven)&&e.captureException(t),console.log("new referralProgram Error: "+t)}),d=f.settle([d,l]).then(function(t){var o;return r=t[0].value,o=t[1].value,e.data.set("referrerId",o.id),r}).catch(function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.Raven)&&e.captureException(t),console.log("order/referralProgram Error: "+t)})),c={orderId:e.data.get("order.id"),total:parseFloat(e.data.get("order.total")/100),shipping:parseFloat(e.data.get("order.shipping")/100),tax:parseFloat(e.data.get("order.tax")/100),discount:parseFloat(e.data.get("order.discount")/100),coupon:e.data.get("order.couponCodes.0")||"",currency:e.data.get("order.currency"),products:[]},p=e.data.get("order.items"),i=s=0,u=p.length;s<u;i=++s)a=p[i],o={id:a.productId,sku:a.productSlug,name:a.productName,quantity:a.quantity,price:parseFloat(a.price/100)},null!=e.opts.analyticsProductTransform&&(o=e.opts.analyticsProductTransform(o)),c.products[i]=o;return n.track("Completed Order",c),{p:d}}}(this))},t}();var C=I;t.Cart=C}(this.Commerce=this.Commerce||{});
