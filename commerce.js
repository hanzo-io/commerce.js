!function(t){"use strict";var e,r,n,o,s,a,u=e={track:function(t,e){var r;if(null!=("undefined"!=typeof window&&null!==window?window.analytics:void 0))try{return window.analytics.track(t,e)}catch(t){return r=t,console.error(r)}}},c=r=function(){function t(t){this.state=t.state,this.value=t.value,this.reason=t.reason}return t.prototype.isFulfilled=function(){return"fulfilled"===this.state},t.prototype.isRejected=function(){return"rejected"===this.state},t}(),d=n=function(){var t,e,r,i;return r=[],i=0,1024,t=function(){for(var t;r.length-i;){try{r[i]()}catch(e){t=e,"undefined"!=typeof console&&console.error(t)}r[i++]=void 0,1024===i&&(r.splice(0,1024),i=0)}},e=function(){var e;return"undefined"!=typeof MutationObserver?(e=document.createElement("div"),new MutationObserver(t).observe(e,{attributes:!0}),function(){e.setAttribute("a",0)}):"undefined"!=typeof setImmediate?function(){setImmediate(t)}:function(){setTimeout(t,0)}}(),function(t){r.push(t),r.length-i==1&&e()}}();a=function(t,e){var r,i;if("function"==typeof t.y)try{i=t.y.call(void 0,e),t.p.resolve(i)}catch(e){r=e,t.p.reject(r)}else t.p.resolve(e)},s=function(t,e){var r,i;if("function"==typeof t.n)try{i=t.n.call(void 0,e),t.p.resolve(i)}catch(e){r=e,t.p.reject(r)}else t.p.reject(e)};var h=o=function(){function t(t){t&&t(function(t){return function(e){return t.resolve(e)}}(this),function(t){return function(e){return t.reject(e)}}(this))}return t.prototype.resolve=function(t){var e,r,i,n;if(void 0===this.state){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));if(t&&("function"==typeof t||"object"==typeof t))try{if(i=!0,"function"==typeof(n=t.then))return void n.call(t,function(t){return function(e){i&&(i&&(i=!1),t.resolve(e))}}(this),function(t){return function(e){i&&(i=!1,t.reject(e))}}(this))}catch(t){return r=t,void(i&&this.reject(r))}this.state="fulfilled",this.v=t,(e=this.c)&&d(function(r){return function(){var r,i,n;for(i=0,n=e.length;i<n;i++)r=e[i],a(r,t)}}())}},t.prototype.reject=function(e){var r;void 0===this.state&&(this.state="rejected",this.v=e,(r=this.c)?d(function(){var t,i,n;for(i=0,n=r.length;i<n;i++)t=r[i],s(t,e)}):t.suppressUncaughtRejectionError||"undefined"==typeof console||console.log("Broken Promise, please catch rejections: ",e,e?e.stack:null))},t.prototype.then=function(e,r){var i,n,o,u;return o=new t,n={y:e,n:r,p:o},void 0===this.state?this.c?this.c.push(n):this.c=[n]:(u=this.state,i=this.v,d(function(){"fulfilled"===u?a(n,i):s(n,i)})),o},t.prototype.catch=function(t){return this.then(null,t)},t.prototype.finally=function(t){return this.then(t,t)},t.prototype.timeout=function(e,r){return r=r||"timeout",new t(function(t){return function(i,n){setTimeout(function(){return n(Error(r))},e),t.then(function(t){i(t)},function(t){n(t)})}}(this))},t.prototype.callback=function(t){return"function"==typeof t&&(this.then(function(e){return t(null,e)}),this.catch(function(e){return t(e,null)})),this},t}(),p=function(t){var e;return(e=new h).resolve(t),e},f=function(t){var e;return(e=new h).reject(t),e},g=function(t){var e,r,i,n,o,s,a;for(s=[],n=0,a=new h,o=function(e,r){e&&"function"==typeof e.then||(e=p(e)),e.then(function(e){s[r]=e,++n===t.length&&a.resolve(s)},function(t){a.reject(t)})},e=r=0,i=t.length;r<i;e=++r)o(t[e],e);return t.length||a.resolve(s),a},y=function(t){return new h(function(e,r){return t.then(function(t){return e(new c({state:"fulfilled",value:t}))}).catch(function(t){return e(new c({state:"rejected",reason:t}))})})},v=function(t){return g(t.map(y))};h.all=g,h.reflect=y,h.reject=f,h.resolve=p,h.settle=v,h.soon=d;var m,w=function(t=""){return t.toUpperCase().replace(/\s/g,"")},I=function(t,e,r,i,n){var o,s,a,u,c,d,h;if(a=w(e),h=w(r),s=w(i),d=w(n),!a||!h||!s&&!d)return[!1,0];if(!t.country)return[!0,0];if(t.country===a){if(!t.state)return[!0,1];if(t.state===h){if(!t.city&&!t.postalCodes)return[!0,2];if(t.city&&t.city===s)return[!0,3];if(t.postalCodes)for(u=0,c=(o=t.postalCodes.split(",")).length;u<c;u++)if(o[u]===d)return[!0,3];return[!1,2]}return[!1,1]}return[!1,0]},q=function(t,e,r,i,n){var o,s,a,u,c,d,h;h=null,o=-1,u=-1;for(a in t)if(s=t[a],[c,d]=I(s,e,r,i,n),c&&d>o){if(3===d)return[s,d,parseInt(a,10)];h=t[a],o=d,u=a}return[h,o,parseInt(u,10)]},k=m=function(){class t{constructor(t,e,r={}){this.client=t,this.data=e,this.opts=r,this.queue=[],this.invoice()}initCart(){var t,e,r,i,n,o;if(!(t=this.data.get("order.cartId"))&&null!=this.client.cart)return this.client.cart.create().then(t=>{var e,r,i,n,o;this.data.set("order.cartId",t.id);i=this.data.get("order.items");for(e=n=0,o=i.length;n<o;e=++n)r=i[e],this._cartSet(r.productId,r.quantity);return this.onCart(t.id)}),this.data.on("set",t=>{if("order.storeId"===t)return this._cartSyncStore()});if(null!=this.client.cart){for(this.onCart(t),e=n=0,o=(i=this.data.get("order.items")).length;n<o;e=++n)r=i[e],this._cartSet(r.productId,r.quantity);return this.onCart(t),this.data.on("set",t=>{"order.storeId"===t&&this._cartSyncStore();"user.firstName"===t&&this._cartSyncName();if("user.lastName"===t)return this._cartSyncName()})}}onCart(t){}_cartSet(t,e){var r;if((r=this.data.get("order.cartId"))&&null!=this.client.cart)return this.client.cart.set({id:r,productId:t,quantity:e,storeId:this.data.get("order.storeId")})}_cartUpdate(t){var e;if((e=this.data.get("order.cartId"))&&null!=this.client.cart)return t.id=e,this.client.cart.update(t)}_cartSyncStore(){var t;if((t=this.data.get("order.cartId"))&&null!=this.client.cart)return this.client.cart.update({id:t,storeId:this.data.get("order.storeId")})}clear(){var t,e,r,i;for(this.queue.length=0,r=0,i=(e=this.data.get("order.items")).length;r<i;r++)t=e[r],this.set(t.productId,0);return this.data.get("order.items")}set(t,e,r=!1){return this.queue.push([t,e,r]),1===this.queue.length&&(this.promise=new h((t,e)=>{this.resolve=t;return this.reject=e}),this._set()),this.promise}get(t){var e,r,i,n,o,s,a,u;for(e=n=0,s=(i=this.data.get("order.items")).length;n<s;e=++n)if((r=i[e]).id===t||r.productId===t||r.productSlug===t)return r;for(e=o=0,a=(u=this.queue).length;o<a;e=++o)if((r=u[e])[0]===t)return{id:r[0],quantity:r[2],locked:r[3]}}_set(){var t,e,r,i,n,o,s,a,c,d,h,l,p,f;if(o=this.data.get("order.items"),0===this.queue.length)return this.invoice(),void(null!=this.resolve&&this.resolve(o));if([i,f,h]=this.queue[0],f<0&&(f=0),0===f){for(r=s=0,c=o.length;s<c&&((n=o[r]).productId!==i&&n.productSlug!==i&&n.id!==i);r=++s);return r<o.length&&(this.data.set("order.items",[]),o.splice(r,1),this.onUpdate(),t={id:n.productId,sku:n.productSlug,name:n.productName,quantity:n.quantity,price:parseFloat(n.price/100)},null!=this.opts.analyticsProductTransform&&(t=this.opts.analyticsProductTransform(t)),u.track("Removed Product",t),this.data.set("order.items",o),this._cartSet(n.productId,0),n.quantity=0,this.onUpdate(n)),this.queue.shift(),void this._set()}for(r=a=0,d=o.length;a<d;r=++a)if((n=o[r]).id===i||n.productId===i||n.productSlug===i)return p=n.quantity,n.quantity=f,n.locked=h,l=f,e=l-p,e>0?(t={id:n.productId,sku:n.productSlug,name:n.productName,quantity:e,price:parseFloat(n.price/100)},null!=this.opts.analyticsProductTransform&&(t=this.opts.analyticsProductTransform(t)),u.track("Added Product",t)):e<0&&(t={id:n.productId,sku:n.productSlug,name:n.productName,quantity:e,price:parseFloat(n.price/100)},null!=this.opts.analyticsProductTransform&&(t=this.opts.analyticsProductTransform(t)),u.track("Removed Product",t)),this.data.set("order.items."+r+".quantity",f),this.data.set("order.items."+r+".locked",h),this._cartSet(n.productId,f),this.onUpdate(n),this.queue.shift(),void this._set();return o.push({id:i,quantity:f,locked:h}),this.waits++,this.load(i)}load(t){return this.client.product.get(t).then(t=>{var e,r,i,n,o,s;this.waits--;n=this.data.get("order.items");for(r=o=0,s=n.length;o<s;r=++o)if(i=n[r],t.id===i.id||t.slug===i.id){e={id:t.id,sku:t.slug,name:t.name,quantity:i.quantity,price:parseFloat(t.price/100)},null!=this.opts.analyticsProductTransform&&(e=this.opts.analyticsProductTransform(e)),u.track("Added Product",e),this.update(t,i),this.data.set("order.items."+r,i),this._cartSet(t.id,i.quantity);break}this.queue.shift();return this._set()}).catch(e=>{var r,i,n,o;this.waits--;console.log(`setItem Error: ${e.stack}`);i=this.data.get("order.items");for(r=n=0,o=i.length;n<o;r=++n)if(i[r].id===t){i.splice(r,1),this.data.set("order.items",i);break}this.queue.shift();return this._set()})}refresh(t){var e;return e=this.data.get("order.items"),this.client.product.get(t).then(t=>{var r,i,n,o;this.waits--;for(r=n=0,o=e.length;n<o;r=++n)if(i=e[r],t.id===i.productId||t.slug===i.productSlug){this.update(t,i);break}return e}).catch(function(t){return console.log(`setItem Error: ${t}`)})}update(t,e){return delete e.id,e.productId=t.id,e.productSlug=t.slug,e.productName=t.name,e.price=t.price,e.listPrice=t.listPrice,e.description=t.description,this.onUpdate(e)}onUpdate(t){}promoCode(t){return null!=t?(this.invoice(),this.client.coupon.get(t).then(e=>{if(!e.enabled)throw new Error("This code is expired.");if(this.data.set("order.coupon",e),this.data.set("order.couponCodes",[t]),this._cartUpdate({coupon:e,couponCodes:[t]}),""!==e.freeProductId&&e.freeQuantity>0)return this.client.product.get(e.freeProductId).then(t=>this.invoice()).catch(function(t){throw new Error("This coupon is invalid.")});this.invoice()})):this.data.get("order.promoCode")}taxRates(t){return null!=t&&(this.data.set("taxRates",t),this.invoice()),this.data.get("taxRates")}shippingRates(t){return null!=t&&(this.data.set("shippingRates",t),this.invoice()),this.data.get("shippingRates")}invoice(){var t,e,r,n,o,s,a,u,c,d,h,p,f,g,y,v,m,w,I,k,R,P,j,S,C,T,_,x,b,A,F,E,N,U,M;if(a=this.data.get("order.items"),n=0,null!=(r=this.data.get("order.coupon")))switch(r.type){case"flat":if(null==r.productId||""===r.productId)n=r.amount||0;else for(u=0,d=(I=this.data.get("order.items")).length;u<d;u++)(s=I[u]).productId===r.productId&&(m=s.quantity,r.once&&(m=1),n+=(r.amount||0)*m);break;case"percent":if(null==r.productId||""===r.productId)for(c=0,h=(k=this.data.get("order.items")).length;c<h;c++)m=(s=k[c]).quantity,r.once&&(m=1),n+=(r.amount||0)*s.price*m*.01;else for(g=0,p=(R=this.data.get("order.items")).length;g<p;g++)(s=R[g]).productId===r.productId&&(m=s.quantity,r.once&&(m=1),n+=(r.amount||0)*s.price*m*.01);n=Math.floor(n)}for(this.data.set("order.discount",n),E=-n,y=0,f=(a=this.data.get("order.items")).length;y<f;y++)E+=(s=a[y]).price*s.quantity;return this.data.set("order.subtotal",E),M=this.data.get("taxRates"),null==(w=this.data.get("order.taxRate"))&&(w={percent:0,cost:0},this.data.set("order.taxRate",w)),null!=M&&(e=this.data.get("order.shippingAddress.country"),F=this.data.get("order.shippingAddress.state"),t=this.data.get("order.shippingAddress.city"),v=this.data.get("order.shippingAddress.postalCode"),[o,l,i]=q(M.geoRates,e,F,t,v),null==o&&(o=w),this.data.set("order.taxRate",o)),A=this.data.get("shippingRates"),null==(w=this.data.get("order.shippingRate"))&&(w={percent:0,cost:0},this.data.set("order.shippingRate",w)),null!=A&&(e=this.data.get("order.shippingAddress.country"),F=this.data.get("order.shippingAddress.state"),t=this.data.get("order.shippingAddress.city"),v=this.data.get("order.shippingAddress.postalCode"),[o,l,i]=q(A.geoRates,e,F,t,v),null==o&&(o=w),this.data.set("order.shippingRate",o)),U=null!=(P=this.data.get("order.taxRate"))?P:{percent:0,cost:0},N=Math.ceil((null!=(j=U.percent)?j:0)*E+(null!=(S=U.cost)?S:0)),b=null!=(C=this.data.get("order.shippingRate"))?C:{percent:0,cost:0},x=Math.ceil((null!=(T=b.percent)?T:0)*E+(null!=(_=b.cost)?_:0)),this.data.set("order.shipping",x),this.data.set("order.tax",N),this.data.set("order.total",E+x+N)}checkout(){var t;return this.invoice(),t={user:this.data.get("user"),order:this.data.get("order"),payment:this.data.get("payment")},this.client.checkout.authorize(t).then(t=>{var e,r,i,n,o,s,a,c,d,l;this.data.set("coupon",this.data.get("order.coupon")||{});this.data.set("order",t);a="ethereum"===t.type?new h(function(e){return e(t)}):this.client.checkout.capture(t.id).then(t=>{this.data.set("order",t);return t}).catch(function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.Raven)&&e.captureException(t),console.log(`capture Error: ${t}`)});l=this.data.get("referralProgram");null!=l&&(c=this.client.referrer.create({userId:this.data.get("order.userId"),orderId:this.data.get("order.id"),program:l,programId:this.data.get("referralProgram.id")}).catch(function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.Raven)&&e.captureException(t),console.log(`new referralProgram Error: ${t}`)}),a=h.settle([a,c]).then(e=>{var r;t=e[0].value;r=e[1].value;this.data.set("referrerId",r.id);return t}).catch(function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.Raven)&&e.captureException(t),console.log(`order/referralProgram Error: ${t}`)}));s={orderId:this.data.get("order.id"),total:parseFloat(this.data.get("order.total")/100),shipping:parseFloat(this.data.get("order.shipping")/100),tax:parseFloat(this.data.get("order.tax")/100),discount:parseFloat(this.data.get("order.discount")/100),coupon:this.data.get("order.couponCodes.0")||"",currency:this.data.get("order.currency"),products:[]};d=this.data.get("order.items");for(r=n=0,o=d.length;n<o;r=++n)e={id:(i=d[r]).productId,sku:i.productSlug,name:i.productName,quantity:i.quantity,price:parseFloat(i.price/100)},null!=this.opts.analyticsProductTransform&&(e=this.opts.analyticsProductTransform(e)),s.products[r]=e;u.track("Completed Order",s);return{p:a}})}}return t.prototype.waits=0,t.prototype.queue=null,t.prototype.data=null,t.prototype.client=null,t.prototype.promise=null,t.prototype.reject=null,t.prototype.resolve=null,t.prototype.opts={},t}();t.Cart=k,t.matchesGeoRate=I,t.closestGeoRate=q,t.clean=w}(this.Commerce=this.Commerce||{});
