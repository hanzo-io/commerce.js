!function(t){"use strict";var e,r,n,i=e={track:function(t,e){var r;if(null!=("undefined"!=typeof window&&null!==window?window.analytics:void 0))try{return window.analytics.track(t,e)}catch(t){return r=t,console.error(r)}}},o=r=function(){function t(t){this.state=t.state,this.value=t.value,this.reason=t.reason}return t.prototype.isFulfilled=function(){return"fulfilled"===this.state},t.prototype.isRejected=function(){return"rejected"===this.state},t}();n=function(){var t,e,r,n,i;return n=[],i=0,t=1024,e=function(){for(var e;n.length-i;){try{n[i]()}catch(t){e=t,"undefined"!=typeof console&&console.error(e)}n[i++]=void 0,i===t&&(n.splice(0,t),i=0)}},r=function(){var t,r;return"undefined"!=typeof MutationObserver?(t=document.createElement("div"),r=new MutationObserver(e),r.observe(t,{attributes:!0}),function(){t.setAttribute("a",0)}):"undefined"!=typeof setImmediate?function(){setImmediate(e)}:function(){setTimeout(e,0)}}(),function(t){n.push(t),n.length-i==1&&r()}}();var s,a,u,c,d,h,l,p=n;d=void 0,u=d,a="fulfilled",c="rejected",l=function(t,e){var r,n;if("function"==typeof t.y)try{n=t.y.call(d,e),t.p.resolve(n)}catch(e){r=e,t.p.reject(r)}else t.p.resolve(e)},h=function(t,e){var r,n;if("function"==typeof t.n)try{n=t.n.call(d,e),t.p.resolve(n)}catch(e){r=e,t.p.reject(r)}else t.p.reject(e)},s=function(){function t(t){t&&t(function(t){return function(e){return t.resolve(e)}}(this),function(t){return function(e){return t.reject(e)}}(this))}return t.prototype.resolve=function(t){var e,r,n,i;if(this.state===u){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));if(t&&("function"==typeof t||"object"==typeof t))try{if(n=!0,"function"==typeof(i=t.then))return void i.call(t,function(t){return function(e){n&&(n&&(n=!1),t.resolve(e))}}(this),function(t){return function(e){n&&(n=!1,t.reject(e))}}(this))}catch(t){return r=t,void(n&&this.reject(r))}this.state=a,this.v=t,(e=this.c)&&p(function(r){return function(){var r,n,i;for(n=0,i=e.length;n<i;n++)r=e[n],l(r,t)}}())}},t.prototype.reject=function(e){var r;this.state===u&&(this.state=c,this.v=e,(r=this.c)?p(function(){var t,n,i;for(n=0,i=r.length;n<i;n++)t=r[n],h(t,e)}):t.suppressUncaughtRejectionError||"undefined"==typeof console||console.log("Broken Promise, please catch rejections: ",e,e?e.stack:null))},t.prototype.then=function(e,r){var n,i,o,s;return o=new t,i={y:e,n:r,p:o},this.state===u?this.c?this.c.push(i):this.c=[i]:(s=this.state,n=this.v,p(function(){s===a?l(i,n):h(i,n)})),o},t.prototype.catch=function(t){return this.then(null,t)},t.prototype.finally=function(t){return this.then(t,t)},t.prototype.timeout=function(e,r){return r=r||"timeout",new t(function(t){return function(n,i){setTimeout(function(){return i(Error(r))},e),t.then(function(t){n(t)},function(t){i(t)})}}(this))},t.prototype.callback=function(t){return"function"==typeof t&&(this.then(function(e){return t(null,e)}),this.catch(function(e){return t(e,null)})),this},t}();var f=s,g=function(t){var e;return e=new f,e.resolve(t),e},y=function(t){var e;return e=new f,e.reject(t),e},v=function(t){var e,r,n,i,o,s,a,u;for(a=[],o=0,u=new f,s=function(e,r){e&&"function"==typeof e.then||(e=g(e)),e.then(function(e){a[r]=e,++o===t.length&&u.resolve(a)},function(t){u.reject(t)})},e=r=0,n=t.length;r<n;e=++r)i=t[e],s(i,e);return t.length||u.resolve(a),u},m=function(t){return new f(function(e,r){return t.then(function(t){return e(new o({state:"fulfilled",value:t}))}).catch(function(t){return e(new o({state:"rejected",reason:t}))})})},w=function(t){return v(t.map(m))};f.all=v,f.reflect=m,f.reject=y,f.resolve=g,f.settle=w,f.soon=p;var I;I=function(){class t{constructor(t,e,r={}){this.client=t,this.data=e,this.opts=r,this.queue=[],this.invoice()}initCart(){var t,e,r,n,i,o;if((t=this.data.get("order.cartId"))||null==this.client.cart){for(this.onCart(t),n=this.data.get("order.items"),e=i=0,o=n.length;i<o;e=++i)r=n[e],this._cartSet(r.productId,r.quantity);return this.onCart(t)}return this.client.cart.create().then(t=>{var e,r,n,i,o;for(this.data.set("order.cartId",t.id),n=this.data.get("order.items"),e=i=0,o=n.length;i<o;e=++i)r=n[e],this._cartSet(r.productId,r.quantity);return this.onCart(t.id)})}onCart(t){}_cartSet(t,e){var r;if((r=this.data.get("order.cartId"))&&null!=this.client.cart)return this.client.cart.set({id:r,productId:t,quantity:e})}_cartUpdate(t){var e;if((e=this.data.get("order.cartId"))&&null!=this.client.cart)return t.id=e,this.client.cart.update(t)}set(t,e,r=!1){return this.queue.push([t,e,r]),1===this.queue.length&&(this.promise=new f((t,e)=>{return this.resolve=t,this.reject=e}),this._set()),this.promise}get(t){var e,r,n,i,o,s,a,u;for(n=this.data.get("order.items"),e=i=0,s=n.length;i<s;e=++i)if(r=n[e],r.id===t||r.productId===t||r.productSlug===t)return r;for(u=this.queue,e=o=0,a=u.length;o<a;e=++o)if(r=u[e],r[0]===t)return{id:r[0],quantity:r[2],locked:r[3]}}_set(){var t,e,r,n,o,s,a,u,c,d,h,l,p,f,g;if(s=this.data.get("order.items"),0===this.queue.length)return this.invoice(),void(null!=this.resolve&&this.resolve(s));if(g=this.queue[0],n=g[0],f=g[1],h=g[2],0===f){for(r=a=0,c=s.length;a<c&&(o=s[r],o.productId!==n&&o.productSlug!==n&&o.id!==n);r=++a);return r<s.length&&(this.data.set("order.items",[]),s.splice(r,1),this.onUpdate(),t={id:o.productId,sku:o.productSlug,name:o.productName,quantity:o.quantity,price:parseFloat(o.price/100)},null!=this.opts.analyticsProductTransform&&(t=this.opts.analyticsProductTransform(t)),i.track("Removed Product",t),this.data.set("order.items",s),this._cartSet(o.productId,0),this.onUpdate(o)),this.queue.shift(),void this._set()}for(r=u=0,d=s.length;u<d;r=++u)if(o=s[r],o.id===n||o.productId===n||o.productSlug===n)return p=o.quantity,o.quantity=f,o.locked=h,l=f,e=l-p,e>0?(t={id:o.productId,sku:o.productSlug,name:o.productName,quantity:e,price:parseFloat(o.price/100)},null!=this.opts.analyticsProductTransform&&(t=this.opts.analyticsProductTransform(t)),i.track("Added Product",t)):e<0&&(t={id:o.productId,sku:o.productSlug,name:o.productName,quantity:e,price:parseFloat(o.price/100)},null!=this.opts.analyticsProductTransform&&(t=this.opts.analyticsProductTransform(t)),i.track("Removed Product",t)),this.data.set("order.items."+r+".quantity",f),this.data.set("order.items."+r+".locked",h),this._cartSet(o.productId,f),this.onUpdate(o),this.queue.shift(),void this._set();return s.push({id:n,quantity:f,locked:h}),this.waits++,this.load(n)}load(t){return this.client.product.get(t).then(t=>{var e,r,n,o,s,a;for(this.waits--,o=this.data.get("order.items"),r=s=0,a=o.length;s<a;r=++s)if(n=o[r],t.id===n.id||t.slug===n.id){e={id:t.id,sku:t.slug,name:t.name,quantity:n.quantity,price:parseFloat(t.price/100)},null!=this.opts.analyticsProductTransform&&(e=this.opts.analyticsProductTransform(e)),i.track("Added Product",e),this.update(t,n),this.data.set("order.items."+r,n),this._cartSet(t.id,n.quantity);break}return this.queue.shift(),this._set()}).catch(e=>{var r,n,i,o,s;for(this.waits--,console.log(`setItem Error: ${e.stack}`),i=this.data.get("order.items"),r=o=0,s=i.length;o<s;r=++o)if(n=i[r],n.id===t){i.splice(r,1),this.data.set("order.items",i);break}return this.queue.shift(),this._set()})}refresh(t){var e;return e=this.data.get("order.items"),this.client.product.get(t).then(t=>{var r,n,i,o;for(this.waits--,r=i=0,o=e.length;i<o;r=++i)if(n=e[r],t.id===n.productId||t.slug===n.productSlug){this.update(t,n);break}return e}).catch(function(t){return console.log(`setItem Error: ${t}`)})}update(t,e){return delete e.id,e.productId=t.id,e.productSlug=t.slug,e.productName=t.name,e.price=t.price,e.listPrice=t.listPrice,e.description=t.description,this.onUpdate(e)}onUpdate(t){}promoCode(t){return null!=t?(this.invoice(),this.client.coupon.get(t).then(e=>{if(!e.enabled)throw new Error("This code is expired.");if(this.data.set("order.coupon",e),this.data.set("order.couponCodes",[t]),this._cartUpdate({coupon:e,couponCodes:[t]}),""!==e.freeProductId&&e.freeQuantity>0)return this.client.product.get(e.freeProductId).then(t=>{return this.invoice()}).catch(function(t){throw new Error("This coupon is invalid.")});this.invoice()})):this.data.get("order.promoCode")}taxRates(t){return null!=t&&(this.data.set("taxRates",t),this.invoice()),this.data.get("taxRates")}shippingRates(t){return null!=t&&(this.data.set("shippingRates",t),this.invoice()),this.data.get("shippingRates")}invoice(){var t,e,r,n,i,o,s,a,u,c,d,h,l,p,f,g,y,v,m,w,I,q,k,C,P,j,R,b,T,S,x,L,_,A;if(o=this.data.get("order.items"),n=0,null!=(r=this.data.get("order.coupon")))switch(r.type){case"flat":if(null==r.productId||""===r.productId)n=r.amount||0;else for(w=this.data.get("order.items"),s=0,c=w.length;s<c;s++)i=w[s],i.productId===r.productId&&(m=i.quantity,r.once&&(m=1),n+=(r.amount||0)*m);break;case"percent":if(null==r.productId||""===r.productId)for(I=this.data.get("order.items"),a=0,d=I.length;a<d;a++)i=I[a],m=i.quantity,r.once&&(m=1),n+=(r.amount||0)*i.price*m*.01;else for(q=this.data.get("order.items"),u=0,h=q.length;u<h;u++)i=q[u],i.productId===r.productId&&(m=i.quantity,r.once&&(m=1),n+=(r.amount||0)*i.price*m*.01);n=Math.floor(n)}for(this.data.set("order.discount",n),o=this.data.get("order.items"),S=-n,g=0,l=o.length;g<l;g++)i=o[g],S+=i.price*i.quantity;if(this.data.set("order.subtotal",S),null!=(A=this.data.get("taxRates")))for(y=0,p=A.length;y<p;y++)if(_=A[y],(t=this.data.get("order.shippingAddress.city"))&&(null==_.city||_.city.toLowerCase()===t.toLowerCase())&&(T=this.data.get("order.shippingAddress.state"))&&(null==_.state||_.state.toLowerCase()===T.toLowerCase())&&(e=this.data.get("order.shippingAddress.country"))&&(null==_.country||_.country.toLowerCase()===e.toLowerCase())){this.data.set("order.taxRate",_.taxRate);break}if(null!=(b=this.data.get("shippingRates")))for(v=0,f=b.length;v<f;v++)if(R=b[v],(t=this.data.get("order.shippingAddress.city"))&&(null==R.city||R.city.toLowerCase()===t.toLowerCase())&&(T=this.data.get("order.shippingAddress.state"))&&(null==R.state||R.state.toLowerCase()===T.toLowerCase())&&(e=this.data.get("order.shippingAddress.country"))&&(null==R.country||R.country.toLowerCase()===e.toLowerCase())){this.data.set("order.shippingRate",R.shippingRate);break}return L=null!=(k=this.data.get("order.taxRate"))?k:0,x=Math.ceil((null!=L?L:0)*S),j=null!=(C=this.data.get("order.shippingRate"))?C:0,P=j,this.data.set("order.shipping",P),this.data.set("order.tax",x),this.data.set("order.total",S+P+x)}checkout(){var t;return this.invoice(),t={user:this.data.get("user"),order:this.data.get("order"),payment:this.data.get("payment")},this.client.checkout.authorize(t).then(e=>{var r,n,o,s,a,u,c,d,h,l;for(this.data.set("coupon",this.data.get("order.coupon")||{}),this.data.set("order",e),c=this.client.checkout.capture(e.id).then(t=>{return this.data.set("order",t),t}).catch(function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.Raven)&&e.captureException(t),console.log(`capture Error: ${t}`)}),l=this.data.get("referralProgram"),null!=l&&(d=this.client.referrer.create({userId:t.order.userId,orderId:t.order.orderId,program:l,programId:this.data.get("referralProgram.id")}).catch(function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.Raven)&&e.captureException(t),console.log(`new referralProgram Error: ${t}`)}),c=f.settle([c,d]).then(t=>{var r;return e=t[0].value,r=t[1].value,this.data.set("referrerId",r.id),e}).catch(function(t){var e;return"undefined"!=typeof window&&null!==window&&null!=(e=window.Raven)&&e.captureException(t),console.log(`order/referralProgram Error: ${t}`)})),u={orderId:this.data.get("order.id"),total:parseFloat(this.data.get("order.total")/100),shipping:parseFloat(this.data.get("order.shipping")/100),tax:parseFloat(this.data.get("order.tax")/100),discount:parseFloat(this.data.get("order.discount")/100),coupon:this.data.get("order.couponCodes.0")||"",currency:this.data.get("order.currency"),products:[]},h=this.data.get("order.items"),n=s=0,a=h.length;s<a;n=++s)o=h[n],r={id:o.productId,sku:o.productSlug,name:o.productName,quantity:o.quantity,price:parseFloat(o.price/100)},null!=this.opts.analyticsProductTransform&&(r=this.opts.analyticsProductTransform(r)),u.products[n]=r;return i.track("Completed Order",u),{p:c}})}}return t.prototype.waits=0,t.prototype.queue=null,t.prototype.data=null,t.prototype.client=null,t.prototype.cartPromise=null,t.prototype.promise=null,t.prototype.reject=null,t.prototype.resolve=null,t.prototype.opts={},t}();var q=I;t.Cart=q}(this.Commerce=this.Commerce||{});
